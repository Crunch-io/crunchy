<!DOCTYPE html>
<html lang="en">
  <head>

    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
    <meta name="description" content="Prepare and analyze survey data quickly and easily.">
    <meta name="keywords" content="Crunch, Crunch io, data, datasets, survey, analytics, analysis, technology, insights, research, software">
    <base href="//crunch-io.github.io/crunchy/newsite/">
    <title>Crunch | Making Graphs Look Easy with ggplot2 and Tidy Evaluation</title>

    <link rel="icon" href="img/favicon.ico">

    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/animate.css/3.5.2/animate.min.css">
    <meta property="og:title" content="Making Graphs Look Easy with ggplot2 and Tidy Evaluation &middot; Online survey data analysis">
<meta property="og:description" content="Prepare and analyze survey data quickly and easily.">
<meta property="og:type" content="website" >
<meta property="og:url" content="//crunch-io.github.io/crunchy/newsite/dev/blog/autoplot-with-tidyeval/">
<meta property="og:locale" content="en">


    
        <meta property="og:image" content="https://crunch.io/img/logo-1200x630.png">
    



  <meta property="og:updated_time" content="2018-08-03T12:12:10-07:00">


    <meta name="twitter:card" content="summary_large_image"/>
<meta name="twitter:image" content="https://crunch.io/img/logo-1200x630.png"/>

<meta name="twitter:title" content="Making Graphs Look Easy with ggplot2 and Tidy Evaluation"/>
<meta name="twitter:description" content="At Crunch, one of the ways we try to make data exploration simple is by providing sensible default views that take into account the properties of your data and metadata. We&rsquo;re in the process of releasing some plotting methods in our crplyr R package that define methods for ggplot2&rsquo;s autoplot() function. autoplot() was the ideal approach for us to encapsulate the logic of how to &ldquo;just do the right thing.&rdquo; You can do the analysis you want, and it will make smart choices about how to display it with no additional input&ndash;all of which you can control or override with additional ggplot2 layers, if you want."/>

    
    <link rel="stylesheet" href="css/main.css">

    
    <script>(function(w,d,s,l,i){w[l]=w[l]||[];w[l].push({'gtm.start':
    new Date().getTime(),event:'gtm.js'});var f=d.getElementsByTagName(s)[0],
    j=d.createElement(s),dl=l!='dataLayer'?'&l='+l:'';j.async=true;j.src=
    'https://www.googletagmanager.com/gtm.js?id='+i+dl;f.parentNode.insertBefore(j,f);
    })(window,document,'script','dataLayer','GTM-5GB59T2');</script>
    




  </head>

  <body>




    
    <noscript><iframe src="https://www.googletagmanager.com/ns.html?id=GTM-5GB59T2"
    height="0" width="0" style="display:none;visibility:hidden"></iframe></noscript>
    

    <nav class="navbar sticky-top navbar-expand-lg navbar-light">
        <div class="container">
            <a class="navbar-brand" aria-label="Crunch.io" href="/"><img class="d-inline-block align-top" src="img/crunch_logo.svg" alt="Crunch.io" height="auto" width="140"></a>
            <button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbarCollapse" aria-controls="navbarCollapse" aria-expanded="false" aria-label="Toggle navigation">
              <span class="navbar-toggler-icon"></span>
            </button>

            <div class="collapse navbar-collapse" id="navbarCollapse">
              <ul class="navbar-nav ml-auto">
                <li class="nav-item dropdown">
                  <a class="nav-link" href="#" id="capabilities" role="button" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
                    Capabilities
                  </a>
                  <div class="dropdown-menu crunch-menu animate__fadeInDown px-sm-0 py-md-1 px-md-3" aria-labelledby="navbarDropdown">
                      <div class="row">
                          <div class="col-md-6 border-right py-md-3 mt-1">
                            <p class="text-left  pb-1 mb-0 font-weight-bold">Crunch.io is for:</p>
                            <a class="dropdown-item" href="for-insights-teams">Insights Teams</a>
                            <a class="dropdown-item" href="market-researchers">Market Research Firms</a>
                          </div>
                          <div class="col-md-6  py-md-3 mt-1">
                            <p class="text-left pb-1 mb-0 font-weight-bold">Crunch.io can deliver:
                            </p>
                            <a class="dropdown-item" href="powerful-survey-analytics">Powerful Survey Analytics</a>
                            <a class="dropdown-item" href="visualization">Visualization and Delivery</a>
                            <a class="dropdown-item" href="dashboards">Dashboards</a>
                            <a class="dropdown-item" href="tracker-analytics">Tracker Analytics</a>
                            <a class="dropdown-item" href="automation">Crunch Automation</a>
                          </div>
                        </div>
                  </div>
                </li>
                <li class="nav-item dropdown">
                  <a class="nav-link" href="#" id="company" role="button" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
                    Company
                  </a>
                  <div class="dropdown-menu animate__fadeInDown" aria-labelledby="company">
                      <a class="dropdown-item" href="about">About</a>
                      <a class="dropdown-item" href="team">Team</a>
                      <a class="dropdown-item" href="jobs">Careers</a>
                      <a class="dropdown-item" href="contact">Contact Us</a>
                  </div>
                </li>
                <li class="nav-item dropdown">
                    <a class="nav-link" href="#" id="resources" role="button" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
                      Resources
                    </a>
                    <div class="dropdown-menu animate__fadeInDown" aria-labelledby="resources">
                        <a class="dropdown-item"  href="resources">Webinars & White Papers</a>
                        <a class="dropdown-item" href="case-studies">Case Studies</a>
                    </div>


                </li>
                <li class="nav-item dropdown">
                  <a class="nav-link" href="#" id="support" role="button" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
                    Support
                  </a>
                  <div class="dropdown-menu animate__fadeInDown" aria-labelledby="support">
                      <a class="dropdown-item" href="http://help.crunch.io/">Help Center</a>
                      <a class="dropdown-item" href="api/reference/">API Reference</a>
                      <a class="dropdown-item" href="dev/features/">Feature Announcements</a>
                      <a class="dropdown-item" href="release-notes/">Release Notes</a>
                      <a class="dropdown-item" href="https://help.crunch.io/hc/en-us/categories/360002688152-Developer-Guides">Developer Guides</a>
                  </div>
                </li>
                <li class="nav-item">
                  <a class="nav-link" href="https://app.crunch.io/" target="_blank" rel="noreferrer">Sign In</a>
                </li>
                <li class="nav-item mb-2 pt-1  mb-sm-0 ml-remove-on-mobile">
                  <button type="button" class="btn btn-primary btn-sm mb-2" onclick="window.location.href='/request-demo'">Request a Demo</button>
                </li>
              </ul>
            </div>
        </div> 
    </nav>


<div id="wrapper">

    <div id="secondary-pages-wrapper">
        <div class="container-fluid">

            <div class="blog-content">
                    <div class="container spacer-top">
                        <div class="row">
                            <div class="col-md-10 offset-md-1">
                                <span class="date">Aug 3, 2018 </span>
                                <h2 class="title">Making Graphs Look Easy with ggplot2 and Tidy Evaluation</h2>
                                <p class="blog-description"></p>
                            </div>
                        </div> 
                </div> 
            </div> 

            <div class="secondary-content">
              <div class="container blog-content-mg">

                  <div class="row spacer-bottom">
                      <div class="col-md-10 offset-md-1">
                          <p>At Crunch, one of the ways we try to make data exploration simple is by
providing sensible default views that take into account the properties
of your data and metadata. We&rsquo;re in the process of releasing some
plotting methods in our <code>crplyr</code> R package that define methods for
<code>ggplot2</code>&rsquo;s
<a href="https://ggplot2.tidyverse.org/reference/autoplot.html"><code>autoplot()</code></a>
function. <code>autoplot()</code> was the ideal approach for us to encapsulate the
logic of how to &ldquo;just do the right thing.&rdquo; You can do the analysis you
want, and it will make smart choices about how to display it with no
additional input&ndash;all of which you can control or override with
additional <code>ggplot2</code> layers, if you want.</p>
<p>This lets us plot Crunch variables and high dimensional survey
cross-tabs easily, while making sure that the plot always fits the data.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-r" data-lang="r"><span style="display:flex;"><span><span style="color:#a6e22e">library</span>(ggplot2)
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">library</span>(crplyr)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>crunch<span style="color:#f92672">::</span><span style="color:#a6e22e">login</span>()
</span></span><span style="display:flex;"><span>ds <span style="color:#f92672">&lt;-</span> <span style="color:#a6e22e">loadDataset</span>(<span style="color:#e6db74">&#34;Not-so-simple dataset with all types&#34;</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>ds <span style="color:#f92672">%&gt;%</span>
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">group_by</span>(pasta, food_groups) <span style="color:#f92672">%&gt;%</span>
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">summarize</span>(count<span style="color:#f92672">=</span><span style="color:#a6e22e">n</span>()) <span style="color:#f92672">%&gt;%</span>
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">autoplot</span>()
</span></span></code></pre></div><p><img src="img/tidyeval/unnamed-chunk-1-1.png" alt=""></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-r" data-lang="r"><span style="display:flex;"><span>ds <span style="color:#f92672">%&gt;%</span>
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">group_by</span>(abolitionists, food_groups) <span style="color:#f92672">%&gt;%</span>
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">summarize</span>(count<span style="color:#f92672">=</span><span style="color:#a6e22e">n</span>()) <span style="color:#f92672">%&gt;%</span>
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">autoplot</span>(<span style="color:#e6db74">&#34;tile&#34;</span>)
</span></span></code></pre></div><p><img src="img/tidyeval/unnamed-chunk-1-2.png" alt=""></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-r" data-lang="r"><span style="display:flex;"><span><span style="color:#a6e22e">autoplot</span>(ds<span style="color:#f92672">$</span>ec, <span style="color:#e6db74">&#34;bar&#34;</span>)
</span></span></code></pre></div><p><img src="img/tidyeval/unnamed-chunk-1-3.png" alt=""></p>
<p>Making it look easy, though, can be hard work. Our <code>autoplot</code> methods
inspect the input objects to understand their dimensionality and data
types and choose an appropriate visualization. Figuring out and passing
the right arguments to the right places can be messy, so in order to
make these functions work, we took advantage of
<a href="https://dplyr.tidyverse.org/articles/programming.html">tidyeval</a>, a
framework that systematizes non-standard evaluation in R, now
also supported in the new <a href="https://www.tidyverse.org/articles/2018/07/ggplot2-3-0-0/">3.0.0 release of
ggplot2</a>.</p>
<p>To illustrate this pattern, this blog post goes through a simplified
example using the &ldquo;diamonds&rdquo; example dataset and pure <code>dplyr</code> methods.
We&rsquo;ll create a plotting function that adjusts to the number of grouping
variables in a tibble. This lets you pipe data from a dplyr pipeline
into a single function and get a meaningful, appropriate plot.</p>
<p>The actual code for our Crunch <code>autoplot</code> methods is
<a href="https://github.com/Crunch-io/crplyr/blob/ggplot-methods/R/plotting.R">here</a>.</p>
<h2 id="non-standard-evaluation-great-power-great-pain">Non-Standard Evaluation: Great Power, Great Pain</h2>
<p>A great feature the R language has is that it lets you access and
manipulate the environment in which a function is called. This
non-standard evaluation (NSE) gives package authors a flexible and
powerful way to build programming interfaces.</p>
<p>At Crunch, we use NSE a lot. One example is in reporting better error
messages. If you send the wrong data to the API, you might get back a
response like <code>400: Payload is malformed</code>. That&rsquo;s not very helpful even
for users who know our API well. We use NSE to inspect the user&rsquo;s
calling environment, figure out which variables or data structures are
causing the problem, and <a href="https://github.com/Crunch-io/rcrunch/blob/1b8ab2f22f3b08d246cd50232c3322de963f0165/R/geo.R#L108">suggest a
fix</a>:
instead of a generic validation message, we error with the more helpful
<code>ds$some_name must be a Crunch Variable</code>, pointing back to the input that the user typed.</p>
<p>Despite working with NSE all the time, we&rsquo;re pretty sure that
we&rsquo;ve never once gotten it right on the first try. The main reason is
that whenever you are capturing an expression to evaluate later you need
to also keep track of which environment you should evaluate that
expression in. This makes it really difficult to pass unevaluated
expressions between functions and have the evaluation occur without
error. For instance, take this code which replaces a <code>missing</code> function
argument with a logical value:</p>
<pre><code>f1 &lt;- function(i, j, ...) {
    args &lt;- eval(substitute(alist(i, j, ...)))
    args &lt;- replace_missing(args)
    return(as.character(args))
}

replace_missing &lt;- function(args){
    out &lt;- lapply(args, function(x){
        if (is.symbol(x)) {
            x &lt;- tryCatch(eval(x), error = function(c){
                msg &lt;- conditionMessage(c)
                if (msg == &quot;argument is missing, with no default&quot;) {
                    return(TRUE)
                } else {
                    stop(c)
                }
            })
        }
        return(eval(x))
    })
    return(out)
}
</code></pre>
<p>This code captures an expression at the top level, and passes it down to
a second function which returns <code>TRUE</code> if it can&rsquo;t find the argument,
and evaluates expression if it can. We use code very similar to this
for <a href="https://github.com/Crunch-io/rcrunch/blob/master/R/cube-subset.R#L116-L131">subsetting CrunchCube
objects</a>.</p>
<p>There&rsquo;s a tricky mistake here though: we aren&rsquo;t specifying in which
environment we want that evaluation to take place. So if we happen to
send a variable that is used somewhere in the call stack, we&rsquo;ll get the
wrong result:</p>
<pre><code>x &lt;- 1
y &lt;- 1

f1(1, , 3)

## [1] &quot;1&quot;    &quot;TRUE&quot; &quot;3&quot;

f1(y, , 3)

## [1] &quot;1&quot;    &quot;TRUE&quot; &quot;3&quot;

f1(x, , 3)

## [1] &quot;x&quot;    &quot;TRUE&quot; &quot;3&quot;
</code></pre>
<p>What&rsquo;s happening here is that when the final <code>eval(x)</code> is happening, <code>x</code>
is identified through lexical scoping, and so it ends up using the <code>x</code>
that&rsquo;s in the <code>lapply</code> environment, rather than the one that&rsquo;s in the
global environment. To fix this, we need to specify the environment
where that evaluation should take place. This is an easy thing to
forget, and presents its own problems if you move functions around, or
later call them in a different order.</p>
<h2 id="enter-the-quosure">Enter the Quosure</h2>
<p>Tidyeval offers a solution to this problem: it bundles the expression
and its environment in a single object called a &ldquo;quosure&rdquo;. What this
means is that as a developer, you don&rsquo;t have to worry about matching
expressions to environments and can pass unevaluated expressions between
functions with confidence. Because the expression and the environment
are bundled together, when you end up evaluating it you won&rsquo;t ever be
surprised by the result.</p>
<h2 id="autoplot">Autoplot</h2>
<p>Back to our <code>autoplot()</code> project, our initial goal is to have a single function that will produce different
plots based on the number of grouping variables in the tibble it
receives. First, we create a general plotting function
that figures out which plotting sub-function to use:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-r" data-lang="r"><span style="display:flex;"><span><span style="color:#a6e22e">library</span>(ggplot2)
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">library</span>(dplyr)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>autoplot <span style="color:#f92672">&lt;-</span> <span style="color:#a6e22e">function</span>(df) {
</span></span><span style="display:flex;"><span>    <span style="color:#75715e"># Add grouping variable which was stripped by summarize</span>
</span></span><span style="display:flex;"><span>    df <span style="color:#f92672">&lt;-</span> df <span style="color:#f92672">%&gt;%</span>
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">group_by</span>(<span style="color:#f92672">!!!</span><span style="color:#a6e22e">groups</span>(df), <span style="color:#f92672">!!</span><span style="color:#a6e22e">sym</span>(<span style="color:#a6e22e">names</span>(df)<span style="color:#a6e22e">[length</span>(<span style="color:#a6e22e">groups</span>(df)) <span style="color:#f92672">+</span> <span style="color:#ae81ff">1</span>]))
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">if </span>(<span style="color:#a6e22e">length</span>(<span style="color:#a6e22e">groups</span>(df)) <span style="color:#f92672">==</span> <span style="color:#ae81ff">1</span>) {
</span></span><span style="display:flex;"><span>        plot_fun <span style="color:#f92672">&lt;-</span> plot_1d
</span></span><span style="display:flex;"><span>    } else {
</span></span><span style="display:flex;"><span>        plot_fun <span style="color:#f92672">&lt;-</span> plot_2d
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>    vars <span style="color:#f92672">&lt;-</span> <span style="color:#a6e22e">syms</span>(<span style="color:#a6e22e">names</span>(df))
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">plot_fun</span>(df, vars)
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>The function inspects the data frame and then selects a plotting
function based on the number of groups in it. It then
captures the names of the dataset as a list of symbols and passes it
down to the plotting function. The next step is to write the two
plotting functions that actually do the work:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-r" data-lang="r"><span style="display:flex;"><span>plot_1d <span style="color:#f92672">&lt;-</span> <span style="color:#a6e22e">function</span>(df, vars){
</span></span><span style="display:flex;"><span>    groups <span style="color:#f92672">&lt;-</span> vars[vars <span style="color:#f92672">%in%</span> <span style="color:#a6e22e">groups</span>(df)]
</span></span><span style="display:flex;"><span>    measure <span style="color:#f92672">&lt;-</span> vars<span style="color:#a6e22e">[length</span>(vars)][[1]]
</span></span><span style="display:flex;"><span>    df <span style="color:#f92672">%&gt;%</span>
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">select</span>(<span style="color:#f92672">!!</span>groups[[1]], <span style="color:#f92672">!!</span>measure) <span style="color:#f92672">%&gt;%</span>
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">arrange</span>(<span style="color:#a6e22e">desc</span>(<span style="color:#f92672">!!</span>measure)) <span style="color:#f92672">%&gt;%</span>
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">ggplot</span>(<span style="color:#a6e22e">aes</span>(x <span style="color:#f92672">=</span> <span style="color:#f92672">!!</span>measure, y <span style="color:#f92672">=</span> <span style="color:#f92672">!!</span>groups[[1]])) <span style="color:#f92672">+</span>
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">geom_point</span>() <span style="color:#f92672">+</span>
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">theme_minimal</span>()
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>diamonds <span style="color:#f92672">%&gt;%</span>
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">group_by</span>(cut) <span style="color:#f92672">%&gt;%</span>
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">tally</span>() <span style="color:#f92672">%&gt;%</span>
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">autoplot</span>()
</span></span></code></pre></div><p><img src="img/tidyeval/unnamed-chunk-5-1.png" alt=""></p>
<p>The convenient thing about using tidy eval in this case is that we can
confidently pass the unevaluated names into both the <code>dplyr</code> and
<code>ggplot2</code> code without worrying that the evaluation will fail. This
means we can arrange the dataset based on the measure name, and then
plot that measure even though we don&rsquo;t know ahead of time what the
measure will be called. We can do the same thing with the 2d plot:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-r" data-lang="r"><span style="display:flex;"><span>plot_2d <span style="color:#f92672">&lt;-</span> <span style="color:#a6e22e">function</span>(df, vars){
</span></span><span style="display:flex;"><span>    groups <span style="color:#f92672">&lt;-</span> vars[vars <span style="color:#f92672">%in%</span> <span style="color:#a6e22e">groups</span>(df)]
</span></span><span style="display:flex;"><span>    measure <span style="color:#f92672">&lt;-</span> vars<span style="color:#a6e22e">[length</span>(vars)][[1]]
</span></span><span style="display:flex;"><span>    df <span style="color:#f92672">%&gt;%</span>
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">select</span>(<span style="color:#f92672">!!!</span>groups, <span style="color:#f92672">!!</span>measure) <span style="color:#f92672">%&gt;%</span>
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">arrange</span>(<span style="color:#a6e22e">desc</span>(<span style="color:#f92672">!!</span>measure)) <span style="color:#f92672">%&gt;%</span>
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">ggplot</span>(<span style="color:#a6e22e">aes</span>(x <span style="color:#f92672">=</span> <span style="color:#f92672">!!</span>measure, y <span style="color:#f92672">=</span> <span style="color:#f92672">!!</span>groups[[1]], , color <span style="color:#f92672">=</span> <span style="color:#f92672">!!</span>groups[[2]])) <span style="color:#f92672">+</span>
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">geom_point</span>() <span style="color:#f92672">+</span>
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">theme_minimal</span>()
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>diamonds <span style="color:#f92672">%&gt;%</span>
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">group_by</span>(cut ,clarity) <span style="color:#f92672">%&gt;%</span>
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">tally</span>() <span style="color:#f92672">%&gt;%</span>
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">autoplot</span>()
</span></span></code></pre></div><p><img src="img/tidyeval/unnamed-chunk-6-1.png" alt=""></p>
<p>This is basically the same code as the 1D plot except that we used the
splice operator (<code>!!!</code>) in the select call and added another grouping
variable on the color dimension.</p>
<p>What happens when you have more than three dimensions? The <code>ggplot2</code>
package allows us to use tidyeval to dynamically add facets.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-r" data-lang="r"><span style="display:flex;"><span>autoplot <span style="color:#f92672">&lt;-</span> <span style="color:#a6e22e">function</span>(df) {
</span></span><span style="display:flex;"><span>    <span style="color:#75715e"># Add grouping variable which was stripped by summarize</span>
</span></span><span style="display:flex;"><span>    df <span style="color:#f92672">&lt;-</span> df <span style="color:#f92672">%&gt;%</span>
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">group_by</span>(<span style="color:#f92672">!!!</span><span style="color:#a6e22e">groups</span>(df), <span style="color:#f92672">!!</span><span style="color:#a6e22e">sym</span>(<span style="color:#a6e22e">names</span>(df)<span style="color:#a6e22e">[length</span>(<span style="color:#a6e22e">groups</span>(df)) <span style="color:#f92672">+</span> <span style="color:#ae81ff">1</span>]))
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    groups <span style="color:#f92672">&lt;-</span> <span style="color:#a6e22e">groups</span>(df)
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">if </span>(<span style="color:#a6e22e">length</span>(groups) <span style="color:#f92672">==</span> <span style="color:#ae81ff">1</span>) {
</span></span><span style="display:flex;"><span>        plot_fun <span style="color:#f92672">&lt;-</span> plot_1d
</span></span><span style="display:flex;"><span>    } else {
</span></span><span style="display:flex;"><span>        plot_fun <span style="color:#f92672">&lt;-</span> plot_2d
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>    vars <span style="color:#f92672">&lt;-</span> <span style="color:#a6e22e">syms</span>(<span style="color:#a6e22e">names</span>(df))
</span></span><span style="display:flex;"><span>    out <span style="color:#f92672">&lt;-</span> <span style="color:#a6e22e">plot_fun</span>(df, vars)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">if </span>(<span style="color:#a6e22e">length</span>(groups) <span style="color:#f92672">&gt;</span> <span style="color:#ae81ff">2</span>) {
</span></span><span style="display:flex;"><span>        groups <span style="color:#f92672">&lt;-</span> <span style="color:#a6e22e">syms</span>(groups)
</span></span><span style="display:flex;"><span>        out <span style="color:#f92672">&lt;-</span> out <span style="color:#f92672">+</span>
</span></span><span style="display:flex;"><span>            <span style="color:#a6e22e">facet_wrap</span>(<span style="color:#a6e22e">vars</span>(<span style="color:#f92672">!!!</span>groups[3<span style="color:#f92672">:</span><span style="color:#a6e22e">length</span>(groups)]))
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">return</span>(out)
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>diamonds <span style="color:#f92672">%&gt;%</span>
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">group_by</span>(cut, color, clarity) <span style="color:#f92672">%&gt;%</span>
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">summarize</span>(number_of_diamonds <span style="color:#f92672">=</span> <span style="color:#a6e22e">n</span>()) <span style="color:#f92672">%&gt;%</span>
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">autoplot</span>()
</span></span></code></pre></div><p><img src="img/tidyeval/unnamed-chunk-7-1.png" alt=""></p>
<h2 id="conclusion">Conclusion</h2>
<p>Tidyeval solves the main challenges of working with R&rsquo;s non-standard evaluation by
bundling expressions and environments into quosures. The new release of
<code>ggplot2</code> unlocks the power of using tidyeval for making powerful
visualizations quickly. Though we could have made <code>autoplot</code> methods for
Crunch objects before tidyeval support, it would have been much more
complicated and error-prone. Using tidyeval and <code>ggplot2</code> 3.0.0 to pass
quosures between functions unlocks powerful new
mechanisms of building user-friendly functions. And that let&rsquo;s us do
what we strive to do most: get out of the way and let our users explore
their data quickly in a way that matches their intuitions for how R and
tidy conventions work.</p>

                      </div>
                  </div>

              </div> 
            </div> 


</div>
            <footer class="footer bg-black">
                <div id="call-action" class="p-4">
                    <div class="d-flex justify-content-center">
                        <a href="/request-demo/" aria-label="Request a demo" class="btn btn-primary btn-lg cta">Request a demo</a>
                    </div>
                </div>

                <div class="container" >
                    <div class="d-flex justify-content-center flex-wrap">

                        <div class="nav-footer col-md-3 pl-0 col-5">
                            <ul class="list ">
                                <li><a class="nav-link " aria-label="Company" href="about">About</a></li>
                                <li><a class="nav-link" aria-label="Resources" href="resources">Resources</a></li>
                                <li><a class="nav-link" aria-label="Support" href="http://help.crunch.io/">Support</a></li>
                                <li><a class="nav-link" aria-label="Careers" href="jobs">Careers</a></li>
                                
                                <li><a class="nav-link" aria-label="" href="about/privacy">Privacy</a></li> 
                                <li><a class="nav-link" aria-label="Sign in" href="https://app.crunch.io/">Sign in</a></li>
                                
                            </ul>
                        </div>

                        <div class="contact-us p-2 col-md-3 col-7">
                            <h4 class="label mb-3">Contact us</h4>
                            <ul class="ml-0 list">
                                <li class="mb-3">
                                    <a aria-label="Contact Phone: 202-780-5550" href="tel:2027805550">
                                    <span>
                                        <svg class="phone-icon" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 15.88 25.81"><g id="Layer_2" data-name="Layer 2"><g id="Layer_1-2" data-name="Layer 1"><path d="M6.24,2.69h0a.85.85,0,0,1,0-.22A.85.85,0,0,0,6.24,2.69Z"/><path d="M7.09,23.11h0a.88.88,0,0,1,.25-.6A.88.88,0,0,0,7.09,23.11Z"/><path d="M14.18,24.82H1.7a.58.58,0,0,1-.57-.57.58.58,0,0,0,.57.57H14.18a.58.58,0,0,0,.57-.57A.58.58,0,0,1,14.18,24.82Z"/><path d="M8.54,22.51a.84.84,0,0,1,.25.6h0A.84.84,0,0,0,8.54,22.51Z"/><path d="M9.08,2.27H6.81a.43.43,0,1,0,0,.85H9.08a.43.43,0,0,0,0-.85Z"/><path d="M9.6,2.47a.57.57,0,0,1,0,.22h0A.57.57,0,0,0,9.6,2.47Z"/><path d="M.75.15A1.69,1.69,0,0,0,0,1.56,1.69,1.69,0,0,1,.75.15Z"/><path d="M14.18,0H1.7A1.56,1.56,0,0,0,.14,1.56V24.25A1.56,1.56,0,0,0,1.7,25.81H14.18a1.56,1.56,0,0,0,1.56-1.56V1.56A1.56,1.56,0,0,0,14.18,0Zm.71,21.41v2.84a.71.71,0,0,1-.71.71H1.7A.71.71,0,0,1,1,24.25v-3h13.9Zm0-15.88V20.42H1v-15h13.9Zm0-1.13v.14H1v-3A.71.71,0,0,1,1.7.85H14.18a.71.71,0,0,1,.71.71Z"/><path d="M7.23,23.11a.71.71,0,1,0,.71-.7A.71.71,0,0,0,7.23,23.11Z"/><rect x="1.13" y="4.4" width="13.61"/><path d="M15.88,1.56A1.69,1.69,0,0,0,15.13.15,1.69,1.69,0,0,1,15.88,1.56Z"/></g></g></svg>
                                    </span> 
                                    202-780-5550
                                </a>
                                </li>
                                <li class="mb-3">
                                    <a aria-label="Sales Contact: sales@crunch.io" href="mailto:sales@crunch.io">
                                    <span> 
                                        <svg class="email-icon" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 26.41 17.86"><g id="Layer_2" data-name="Layer 2"><g id="Layer_1-2" data-name="Layer 1"><path d="M25.22,0H1.2A1.19,1.19,0,0,0,0,1.19V16.66a1.2,1.2,0,0,0,1.2,1.2h24a1.19,1.19,0,0,0,1.19-1.2V1.19A1.19,1.19,0,0,0,25.22,0ZM10.6,8.85,13,10.7a.36.36,0,0,0,.47,0l2.37-1.85,9.29,8.26H1.32ZM1.42.75H25L13.21,9.93Zm15,7.63,9.24-7.21V16.61ZM10,8.38.75,16.61V1.19h0Z"/></g></g></svg>
                                    </span>
                                        sales@crunch.io
                                    </a>
                                    </li>
                                <li class="mb-3">
                                    <a  aria-label="Contact support: support@crunch.io" href="mailto:support@crunch.io">
                                    <span> 
                                        <svg class="email-icon" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 26.41 17.86"><g id="Layer_2" data-name="Layer 2"><g id="Layer_1-2" data-name="Layer 1"><path d="M25.22,0H1.2A1.19,1.19,0,0,0,0,1.19V16.66a1.2,1.2,0,0,0,1.2,1.2h24a1.19,1.19,0,0,0,1.19-1.2V1.19A1.19,1.19,0,0,0,25.22,0ZM10.6,8.85,13,10.7a.36.36,0,0,0,.47,0l2.37-1.85,9.29,8.26H1.32ZM1.42.75H25L13.21,9.93Zm15,7.63,9.24-7.21V16.61ZM10,8.38.75,16.61V1.19h0Z"/></g></g></svg>
                                    </span>
                                    support@crunch.io
                                    </a>
                                </li>
                            </ul>
                            <div class="d-block d-md-none">
                                <h4 class="crunch-h4">Follow us</h4>
        
                                <div class="d-flex my-2 justify-content-start">
                                    <a class="mr-3" href="https://twitter.com/crunchio" aria-label="Twitter" target="_blank" rel="noopener">
                                        <svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" width="22.753" height="18.491" viewBox="0 0 22.753 18.491">
                                            <defs>
                                            <clipPath id="clip-path">
                                                <rect id="Rectangle_267" data-name="Rectangle 267" width="22.753" height="18.491" fill="#fff"/>
                                            </clipPath>
                                            </defs>
                                            <g id="Group_933" data-name="Group 933" transform="translate(0 0)">
                                            <g id="Group_932" data-name="Group 932" transform="translate(0 0)" clip-path="url(#clip-path)">
                                                <path id="Path_146" data-name="Path 146" d="M22.753,2.189a9.288,9.288,0,0,1-2.681.735A4.678,4.678,0,0,0,22.124.341,9.344,9.344,0,0,1,19.16,1.474a4.672,4.672,0,0,0-7.954,4.257A13.249,13.249,0,0,1,1.584.854,4.673,4.673,0,0,0,3.028,7.087,4.645,4.645,0,0,1,.914,6.5c0,.019,0,.039,0,.059a4.671,4.671,0,0,0,3.745,4.577,4.674,4.674,0,0,1-1.23.164,4.625,4.625,0,0,1-.878-.084,4.673,4.673,0,0,0,4.36,3.242,9.365,9.365,0,0,1-5.8,2A9.53,9.53,0,0,1,0,16.394a13.212,13.212,0,0,0,7.156,2.1A13.191,13.191,0,0,0,20.437,5.209c0-.2,0-.4-.013-.6a9.473,9.473,0,0,0,2.329-2.416" transform="translate(0 0)" fill="#fff"/>
                                            </g>
                                            </g>
                                        </svg>
                                        
                                    </a>
                                    <a href="https://www.linkedin.com/company/crunch.io/" aria-label="Linkedin" target="_blank" rel="noopener">
                                        <svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" width="18.374" height="18.491" viewBox="0 0 18.374 18.491">
                                            <defs>
                                            <clipPath id="clip-path">
                                                <rect id="Rectangle_268" data-name="Rectangle 268" width="18.374" height="18.491" fill="#fff"/>
                                            </clipPath>
                                            </defs>
                                            <g id="Group_935" data-name="Group 935" transform="translate(0 0)">
                                            <g id="Group_934" data-name="Group 934" transform="translate(0 0)" clip-path="url(#clip-path)">
                                                <path id="Path_147" data-name="Path 147" d="M26.547,22.386v-.029l-.019.029Z" transform="translate(-16.666 -14.046)" fill="#fff"/>
                                                <path id="Path_148" data-name="Path 148" d="M17.016,0H1.357A1.342,1.342,0,0,0,0,1.325V17.166a1.342,1.342,0,0,0,1.357,1.325H17.016a1.342,1.342,0,0,0,1.358-1.325V1.325A1.342,1.342,0,0,0,17.016,0M5.569,15.479H2.794V7.13H5.569ZM4.182,5.989H4.163A1.447,1.447,0,1,1,4.2,3.1a1.447,1.447,0,1,1-.018,2.885m11.394,9.49H12.8V11.012c0-1.122-.4-1.888-1.406-1.888a1.52,1.52,0,0,0-1.424,1.015,1.9,1.9,0,0,0-.091.677v4.663H7.105s.036-7.566,0-8.349H9.88V8.311a2.756,2.756,0,0,1,2.5-1.379c1.826,0,3.195,1.194,3.195,3.759Z" transform="translate(0 0)" fill="#fff"/>
                                            </g>
                                            </g>
                                        </svg>
                                    </a>
                                </div>
                            </div>
                        </div> 
                        
                        <div class="follow-us p-2 col-md-6 col-12">
                            <div class="d-none d-md-block">
                            <h4 class="crunch-h4 label">Follow us</h4>

                            <div class="d-flex my-2 justify-content-start">
                                <a class="mr-3" href="https://twitter.com/crunchio" aria-label="Twitter" target="_blank" rel="noopener">
                                    <svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" width="22.753" height="18.491" viewBox="0 0 22.753 18.491">
                                        <defs>
                                        <clipPath id="clip-path">
                                            <rect id="Rectangle_267" data-name="Rectangle 267" width="22.753" height="18.491" fill="#fff"/>
                                        </clipPath>
                                        </defs>
                                        <g id="Group_933" data-name="Group 933" transform="translate(0 0)">
                                        <g id="Group_932" data-name="Group 932" transform="translate(0 0)" clip-path="url(#clip-path)">
                                            <path id="Path_146" data-name="Path 146" d="M22.753,2.189a9.288,9.288,0,0,1-2.681.735A4.678,4.678,0,0,0,22.124.341,9.344,9.344,0,0,1,19.16,1.474a4.672,4.672,0,0,0-7.954,4.257A13.249,13.249,0,0,1,1.584.854,4.673,4.673,0,0,0,3.028,7.087,4.645,4.645,0,0,1,.914,6.5c0,.019,0,.039,0,.059a4.671,4.671,0,0,0,3.745,4.577,4.674,4.674,0,0,1-1.23.164,4.625,4.625,0,0,1-.878-.084,4.673,4.673,0,0,0,4.36,3.242,9.365,9.365,0,0,1-5.8,2A9.53,9.53,0,0,1,0,16.394a13.212,13.212,0,0,0,7.156,2.1A13.191,13.191,0,0,0,20.437,5.209c0-.2,0-.4-.013-.6a9.473,9.473,0,0,0,2.329-2.416" transform="translate(0 0)" fill="#fff"/>
                                        </g>
                                        </g>
                                    </svg>
                                    
                                </a>
                                <a href="https://www.linkedin.com/company/crunch.io/" aria-label="linkedin" target="_blank" rel="noopener">
                                    <svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" width="18.374" height="18.491" viewBox="0 0 18.374 18.491">
                                        <defs>
                                        <clipPath id="clip-path">
                                            <rect id="Rectangle_268" data-name="Rectangle 268" width="18.374" height="18.491" fill="#fff"/>
                                        </clipPath>
                                        </defs>
                                        <g id="Group_935" data-name="Group 935" transform="translate(0 0)">
                                        <g id="Group_934" data-name="Group 934" transform="translate(0 0)" clip-path="url(#clip-path)">
                                            <path id="Path_147" data-name="Path 147" d="M26.547,22.386v-.029l-.019.029Z" transform="translate(-16.666 -14.046)" fill="#fff"/>
                                            <path id="Path_148" data-name="Path 148" d="M17.016,0H1.357A1.342,1.342,0,0,0,0,1.325V17.166a1.342,1.342,0,0,0,1.357,1.325H17.016a1.342,1.342,0,0,0,1.358-1.325V1.325A1.342,1.342,0,0,0,17.016,0M5.569,15.479H2.794V7.13H5.569ZM4.182,5.989H4.163A1.447,1.447,0,1,1,4.2,3.1a1.447,1.447,0,1,1-.018,2.885m11.394,9.49H12.8V11.012c0-1.122-.4-1.888-1.406-1.888a1.52,1.52,0,0,0-1.424,1.015,1.9,1.9,0,0,0-.091.677v4.663H7.105s.036-7.566,0-8.349H9.88V8.311a2.756,2.756,0,0,1,2.5-1.379c1.826,0,3.195,1.194,3.195,3.759Z" transform="translate(0 0)" fill="#fff"/>
                                        </g>
                                        </g>
                                    </svg>
                                </a>
                            </div>
                            </div>  
                            <div id="suscribe" class="row flex-wrap">
                                <p class="mx-md-0 mx-3">Sign up to the <a href="/">Crunch.io</a> newsletter for product updates, industry insights and more.</p>
                                <script charset="utf-8" type="text/javascript" src="//js.hsforms.net/forms/v2.js"></script>
                                <script>
                                    hbspt.forms.create({
                                      region: "na1",
                                      portalId: "3869056",
                                      formId: "1d9b0565-b0af-44b5-a0fa-c389768043c7",
                                      css:' label#label-email-1d9b0565-b0af-44b5-a0fa-c389768043c7 { display: none;} form#hsForm_1d9b0565-b0af-44b5-a0fa-c389768043c7{display:flex;flex-wrap:nowrap;justify-content:center} input#email-1d9b0565-b0af-44b5-a0fa-c389768043c7 {\
                                      padding: 0.65rem;\
                                      border-radius: 4px;\
                                      border: 0px;\
                                      width: 100%;}\
                                      .input {\
                                        width: calc(23vw);\
                                    } @media (max-width: 767px) {\
                                        .input {\
                                         margin:0 0 20px 0;\
                                         width: calc(82vw);\
                                        }\
                                        form#hsForm_1d9b0565-b0af-44b5-a0fa-c389768043c7{display:flex;flex-wrap:wrap;justify-content:center}\
                                        input.btn.btn-primary.btn-block.mx-2{\
                                            width: calc(82vw);\
                                        }\
                                    }',
                                      submitButtonClass:"btn btn-primary btn-block  mx-2 ",
                                      onFormReady: function($form) {
                                          var email_input = document.querySelector("#email-1d9b0565-b0af-44b5-a0fa-c389768043c7")
                                          email_input.setAttribute("placeholder","Email address");
                                          email_input.classList.add("p-2");
                                          email_input.classList.add("col-md-6");
                                          email_input.classList.add("mx-2");
                                      }
                                    });
                                </script>
                            </div>
                        </div> 

                    </div> 
                </div>
                <div id="copy" class="border-top pt-4 px-4">
              
                    <a aria-label="Crunch.io" href="http://crunch.io">â“’ Crunch.io 2022</a>
                </div>
                </div> 
            </footer>

        </div> 

    </div> 

</div> 


<div class="alert alert-dismissible text-center cookiealert" role="alert">
  <div class="cookiealert-container">
      <div class="row">
          <div class="col-sm-8 col-md-10 text-left">
              Crunch.io uses cookies to ensure you get the best experience on our site. By using this site, you agree to the use of cookies in accordance with our <a href="about/privacy">Cookie Policy</a>.
          </div>

          <div class="col-sm-4 col-md-2">
              <button type="button" class="btn btn-primary acceptcookies" aria-label="Close"> I accept </button>
          </div>
      </div>
  </div>
</div>



<div class="modal fade" id="Modal" tabindex="-1" role="dialog" aria-labelledby="ModalLabel" aria-hidden="true">
  <div class="modal-dialog" role="document">
    <div class="modal-content">
      <div class="modal-body">
      </div>
    </div>
  </div>
</div>

<script src="https://code.jquery.com/jquery-3.6.0.min.js" integrity="sha256-/xUj+3OJU5yExlq6GSYGSHk7tPXikynS7ogEvDej/m4=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.12.9/umd/popper.min.js" integrity="sha384-ApNbgh9B+Y1QKtv3Rn7W3mgPxhU9K/ScQsAP7hUibX39j7fakFPskvXusvfa0b4Q" crossorigin="anonymous"></script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@4.6.1/dist/js/bootstrap.bundle.min.js" integrity="sha384-fQybjgWLrvvRgtW6bFlB7jaZrFsaBXjsOMm/tB9LTS58ONXgqbR9W8oWht/amnpF" crossorigin="anonymous"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/wow/1.1.2/wow.min.js"></script>
<script src="https://js.hsforms.net/forms/shell.js"></script>
<script src="https://cdn.jsdelivr.net/gh/Wruczek/Bootstrap-Cookie-Alert@gh-pages/cookiealert.js"></script>
<script src="https://cdn.jsdelivr.net/npm/fuse.js/dist/fuse.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/mark.js/8.11.1/jquery.mark.min.js"></script>
<script src="js/search.js"></script>
<script src="js/script.js"></script>

</body>
</html>

